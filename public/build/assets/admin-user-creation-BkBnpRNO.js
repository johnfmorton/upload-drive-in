document.addEventListener("DOMContentLoaded",function(){const O=document.getElementById("admin-form"),o=document.getElementById("email"),l=document.getElementById("password"),f=document.getElementById("password_confirmation"),d=document.getElementById("name"),g=document.getElementById("submit-btn");if(!O)return;const I={length:{min:8,element:document.getElementById("req-length")},uppercase:{regex:/[A-Z]/,element:document.getElementById("req-uppercase")},lowercase:{regex:/[a-z]/,element:document.getElementById("req-lowercase")},number:{regex:/[0-9]/,element:document.getElementById("req-number")},special:{regex:/[^A-Za-z0-9]/,element:document.getElementById("req-special")}},y=document.getElementById("strength-bar"),b=document.getElementById("strength-text"),x=document.getElementById("password-match-indicator"),L=document.getElementById("match-success"),E=document.getElementById("match-error"),m=document.getElementById("password-match-text");let v=null,u=!1,w=!1,C=!1,p=!1;function M(){o&&(o.addEventListener("input",K(N,500)),o.addEventListener("blur",N)),l&&(l.addEventListener("input",T),l.addEventListener("blur",T)),f&&(f.addEventListener("input",P),f.addEventListener("blur",P)),d&&(d.addEventListener("input",A),d.addEventListener("blur",A));const e=document.getElementById("toggle-password");e&&e.addEventListener("click",W),i(),setInterval(F,3e5)}async function N(){var s;const e=o.value.trim();if(v&&(v.abort(),v=null),k(o),!e){c(o,"Email address is required"),u=!1,i();return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){c(o,"Please enter a valid email address"),u=!1,i();return}Z(o,"Checking email availability...");try{const r=new AbortController;v=r;const n=(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content");if(!n){console.error("CSRF token not found. Please refresh the page."),c(o,"Session expired. Please refresh the page."),u=!1,i();return}const a=await fetch("/setup/ajax/validate-email",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({email:e}),signal:r.signal});if(a.status===419){console.warn("CSRF token expired during email validation, refreshing..."),await F(),B(o,"Session refreshed. Please try again."),u=!1,i();return}const h=await a.json();v=null,h.available?(q(o,"Email address is available"),u=!0):(c(o,h.message||"This email address is already in use"),u=!1);try{await F()}catch(X){console.warn("Failed to refresh CSRF token after email validation:",X)}}catch(r){if(v=null,r.name==="AbortError")return;console.error("Email validation error:",r),B(o,"Unable to verify email availability. Please try again."),u=!1}i()}function T(){const e=l.value;let t=0,s=0;if(Object.keys(I).length,k(l),!e){j(),w=!1,i();return}Object.entries(I).forEach(([r,n])=>{const a=n.element;if(!a)return;let h=!1;r==="length"?h=e.length>=n.min:n.regex&&(h=n.regex.test(e)),h?(a.classList.remove("text-gray-400"),a.classList.add("text-green-600"),a.querySelector("svg").classList.remove("text-gray-400"),a.querySelector("svg").classList.add("text-green-600"),t+=20,s++):(a.classList.remove("text-green-600"),a.classList.add("text-gray-400"),a.querySelector("svg").classList.remove("text-green-600"),a.querySelector("svg").classList.add("text-gray-400"))}),V(t),w=s>=4,e.length<8?(c(l,"Password must be at least 8 characters long"),w=!1):s<3?(B(l,"Password should meet more security requirements"),w=!1):w&&q(l,"Password meets security requirements"),f.value&&P(),i()}function P(){const e=l.value,t=f.value;if(k(f),!t){H(),C=!1,i();return}e===t?(z(),C=!0):($(),c(f,"Passwords do not match"),C=!1),i()}function A(){const e=d.value.trim();k(d),e?e.length<2?(c(d,"Name must be at least 2 characters long"),p=!1):e.length>255?(c(d,"Name must not exceed 255 characters"),p=!1):/^[a-zA-Z\s\-\'\.]+$/.test(e)?(q(d,"Valid administrator name"),p=!0):(c(d,"Name can only contain letters, spaces, hyphens, apostrophes, and periods"),p=!1):(c(d,"Administrator name is required"),p=!1),i()}function V(e,t,s){if(!y||!b)return;let r="Very Weak",n="bg-red-500",a="text-red-600";e>=80?(r="Very Strong",n="bg-green-500",a="text-green-600"):e>=60?(r="Strong",n="bg-green-400",a="text-green-600"):e>=40?(r="Medium",n="bg-yellow-500",a="text-yellow-600"):e>=20&&(r="Weak",n="bg-orange-500",a="text-orange-600"),y.style.width=`${Math.min(e,100)}%`,y.className=`h-2 rounded-full transition-all duration-300 ${n}`,b.textContent=r,b.className=`font-medium ${a}`}function j(){y&&(y.style.width="0%",y.className="h-2 rounded-full transition-all duration-300 bg-gray-300"),b&&(b.textContent="Enter password",b.className="font-medium text-gray-400"),Object.values(I).forEach(e=>{var s,r;const t=e.element;t&&(t.classList.remove("text-green-600"),t.classList.add("text-gray-400"),(s=t.querySelector("svg"))==null||s.classList.remove("text-green-600"),(r=t.querySelector("svg"))==null||r.classList.add("text-gray-400"))})}function z(){x&&L&&E&&(x.classList.remove("hidden"),L.classList.remove("hidden"),E.classList.add("hidden")),m&&(m.textContent="Passwords match",m.className="mt-2 text-sm text-green-600")}function $(){x&&L&&E&&(x.classList.remove("hidden"),L.classList.add("hidden"),E.classList.remove("hidden")),m&&(m.textContent="Passwords do not match",m.className="mt-2 text-sm text-red-600")}function H(){x&&x.classList.add("hidden"),m&&(m.textContent="Re-enter your password to confirm",m.className="mt-2 text-sm text-gray-500")}function W(){const e=document.getElementById("eye-closed"),t=document.getElementById("eye-open");l.type==="password"?(l.type="text",e.classList.add("hidden"),t.classList.remove("hidden")):(l.type="password",e.classList.remove("hidden"),t.classList.add("hidden"))}function c(e,t){e.classList.remove("border-gray-300","border-green-300","border-yellow-300","focus:border-red-500"),e.classList.add("border-red-300","focus:border-red-500");const s=S(e);s.textContent=t,s.className="field-feedback mt-2 text-sm text-red-600",s.setAttribute("data-validation-message","true")}function q(e,t){e.classList.remove("border-gray-300","border-red-300","border-yellow-300","focus:border-red-500"),e.classList.add("border-green-300");const s=S(e);s.textContent=t,s.className="field-feedback mt-2 text-sm text-green-600",s.setAttribute("data-validation-message","true")}function B(e,t){e.classList.remove("border-gray-300","border-red-300","border-green-300","focus:border-red-500"),e.classList.add("border-yellow-300");const s=S(e);s.textContent=t,s.className="field-feedback mt-2 text-sm text-yellow-600",s.setAttribute("data-validation-message","true")}function Z(e,t){e.classList.remove("border-red-300","border-green-300","border-yellow-300","focus:border-red-500"),e.classList.add("border-gray-300");const s=S(e);s.innerHTML=`
            <div class="flex items-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ${t}
            </div>
        `,s.className="field-feedback mt-2 text-sm text-gray-500",s.setAttribute("data-validation-message","true")}function k(e){e.classList.remove("border-red-300","border-green-300","border-yellow-300","focus:border-red-500"),e.classList.contains("border-gray-300")||e.classList.add("border-gray-300"),R(e)}function R(e){const t=e.parentNode;t.querySelectorAll('[data-validation-message="true"]').forEach(a=>a.remove()),t.querySelectorAll(".field-feedback").forEach(a=>a.remove()),t.querySelectorAll("p.text-red-600, p.text-green-600, p.text-yellow-600").forEach(a=>{a.textContent.includes("Enter the full name for the administrator")||a.textContent.includes("This email will be used to log into")||a.textContent.includes("Re-enter your password to confirm")||a.textContent.includes("Password must contain:")||a.textContent.includes("At least 8 characters")||a.textContent.includes("One uppercase letter")||a.textContent.includes("One lowercase letter")||a.textContent.includes("One number")||a.textContent.includes("One special character")||a.remove()})}function S(e){R(e);const t=document.createElement("p");t.className="field-feedback mt-2 text-sm";const s=e.parentNode,r=s.querySelector("p:not(.field-feedback)");return r?s.insertBefore(t,r):s.appendChild(t),t}function i(){if(!g)return;p&&u&&w&&C?(g.disabled=!1,g.classList.remove("opacity-50","cursor-not-allowed"),g.classList.add("hover:bg-blue-700")):(g.disabled=!0,g.classList.add("opacity-50","cursor-not-allowed"),g.classList.remove("hover:bg-blue-700"))}async function F(){var e;try{const t=await fetch("/setup/ajax/refresh-csrf-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content")}});if(t.ok){const s=await t.json();if(s.success&&s.token){const r=document.querySelector('meta[name="csrf-token"]');r&&r.setAttribute("content",s.token);const n=document.querySelector('input[name="_token"]');n&&(n.value=s.token),console.log("CSRF token refreshed successfully")}}}catch(t){console.warn("Failed to refresh CSRF token:",t)}}function K(e,t){let s;return function(...n){const a=()=>{clearTimeout(s),e(...n)};clearTimeout(s),s=setTimeout(a,t)}}M()});
